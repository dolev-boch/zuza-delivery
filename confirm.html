<!DOCTYPE html>
<html dir="rtl" lang="he">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>××™×©×•×¨ ×ª×¢×•×“×ª ××©×œ×•×— - ×–×•×–×” ×¤×˜×™×¡×¨×™</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
        background: linear-gradient(135deg, #1a2f2f 0%, #2d4a4a 100%);
        min-height: 100vh;
        padding: 20px;
        direction: rtl;
      }
      .container {
        max-width: 900px;
        margin: 0 auto;
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }
      .header {
        background: linear-gradient(135deg, #1a2f2f 0%, #2d4a4a 100%);
        padding: 40px 30px;
        text-align: center;
        color: white;
      }
      .brand {
        font-size: 48px;
        font-style: italic;
        font-family: Georgia, serif;
        color: #c4a575;
        margin-bottom: 8px;
      }
      .brand-subtitle {
        font-size: 11px;
        letter-spacing: 4px;
        opacity: 0.9;
      }
      .header-title {
        font-size: 24px;
        color: #c4a575;
        margin-top: 20px;
        font-weight: 600;
      }
      .info-section {
        background: #fff9f0;
        padding: 30px;
        border-bottom: 3px solid #c4a575;
      }
      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
      }
      .info-item {
        display: flex;
        flex-direction: column;
      }
      .info-label {
        font-size: 13px;
        color: #666;
        font-weight: 600;
        margin-bottom: 4px;
      }
      .info-value {
        font-size: 16px;
        color: #1a2f2f;
        font-weight: bold;
      }
      .content {
        padding: 30px;
      }
      .instruction {
        background: #e8f4f8;
        padding: 20px;
        border-radius: 8px;
        border-right: 4px solid #4caf50;
        margin-bottom: 30px;
      }
      .instruction h2 {
        font-size: 18px;
        color: #1a2f2f;
        margin-bottom: 10px;
      }
      .instruction p {
        color: #555;
        line-height: 1.6;
      }
      .category-section {
        margin-bottom: 30px;
      }
      .category-header {
        background: #1a2f2f;
        color: #c4a575;
        padding: 12px 20px;
        font-size: 18px;
        font-weight: 600;
        border-radius: 8px 8px 0 0;
      }
      .products-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 0 0 8px 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .products-table thead {
        background: #f5f5f5;
      }
      .products-table th {
        padding: 14px 16px;
        text-align: right;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #e0e0e0;
        font-size: 14px;
      }
      .products-table th.quantity-col {
        text-align: center;
        width: 180px;
      }
      .products-table tbody tr {
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.2s;
      }
      .products-table tbody tr:hover {
        background: #fafafa;
      }
      .products-table td {
        padding: 14px 16px;
        color: #333;
      }
      .product-name {
        font-size: 15px;
        font-weight: 500;
      }
      .product-notes {
        font-size: 13px;
        color: #666;
      }

      /* Quantity Controls with Plus/Minus Buttons */
      .quantity-input-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
      }
      .quantity-btn {
        width: 44px;
        height: 44px;
        border: 2px solid #ddd;
        background: white;
        border-radius: 8px;
        font-size: 24px;
        font-weight: bold;
        color: #333;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
      }
      .quantity-btn:active {
        transform: scale(0.95);
        background: #f0f0f0;
      }
      .quantity-btn.minus {
        color: #f44336;
        border-color: #f44336;
      }
      .quantity-btn.minus:hover:not(:disabled) {
        background: #ffebee;
        border-color: #d32f2f;
      }
      .quantity-btn.plus {
        color: #4caf50;
        border-color: #4caf50;
      }
      .quantity-btn.plus:hover:not(:disabled) {
        background: #e8f5e9;
        border-color: #388e3c;
      }
      .quantity-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
        background: #f5f5f5;
      }
      .quantity-display {
        min-width: 60px;
        padding: 8px 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        text-align: center;
        font-size: 18px;
        font-weight: bold;
        background: white;
        transition: all 0.3s;
      }
      .quantity-display.changed {
        border-color: #ff9800;
        background: #fff3e0;
        box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
      }

      .actions {
        position: sticky;
        bottom: 0;
        background: white;
        padding: 20px 30px;
        border-top: 2px solid #e0e0e0;
        display: flex;
        gap: 15px;
        justify-content: center;
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
      }
      .btn {
        padding: 16px 40px;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
      }
      .btn-confirm {
        background: #4caf50;
        color: white;
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
      }
      .btn-confirm:hover:not(:disabled) {
        background: #45a049;
        transform: translateY(-2px);
      }
      .btn-confirm:active:not(:disabled) {
        transform: translateY(0);
      }
      .btn-custom {
        background: #ff9800;
        color: white;
        box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
      }
      .btn-custom:hover:not(:disabled) {
        background: #f57c00;
        transform: translateY(-2px);
      }
      .btn-custom:active:not(:disabled) {
        transform: translateY(0);
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Loading Overlay */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(26, 47, 47, 0.95);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        flex-direction: column;
      }
      .loading-overlay.show {
        display: flex;
      }
      .spinner {
        border: 4px solid rgba(196, 165, 117, 0.3);
        border-top: 4px solid #c4a575;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 0.8s linear infinite;
        margin-bottom: 20px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .loading-text {
        color: #c4a575;
        font-size: 18px;
        font-weight: 600;
        text-align: center;
      }
      .loading-subtext {
        color: rgba(196, 165, 117, 0.8);
        font-size: 14px;
        margin-top: 10px;
      }

      .loading {
        text-align: center;
        padding: 60px 20px;
      }
      .error {
        background: #ffebee;
        color: #c62828;
        padding: 20px;
        border-radius: 8px;
        border-right: 4px solid #c62828;
        margin: 20px;
      }
      .success {
        background: #e8f5e9;
        color: #2e7d32;
        padding: 40px;
        border-radius: 8px;
        border-right: 4px solid #4caf50;
        text-align: center;
        margin: 20px;
      }
      .success h2 {
        font-size: 28px;
        margin-bottom: 10px;
      }
      /* Add Products Modal */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10001;
        padding: 20px;
      }
      .modal-overlay.show {
        display: flex;
      }
      .modal-content {
        background: white;
        border-radius: 12px;
        max-width: 800px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      }
      .modal-header {
        background: #2196f3;
        color: white;
        padding: 20px 30px;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .modal-header h2 {
        font-size: 22px;
        margin: 0;
      }
      .modal-close {
        background: none;
        border: none;
        color: white;
        font-size: 28px;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.2s;
      }
      .modal-close:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      .modal-body {
        padding: 30px;
      }
      .modal-search {
        margin-bottom: 20px;
      }
      .modal-search input {
        width: 100%;
        padding: 14px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
      }
      .modal-search input:focus {
        outline: none;
        border-color: #2196f3;
      }
      .modal-category {
        margin-bottom: 20px;
      }
      .modal-category-header {
        background: #f5f5f5;
        padding: 12px 16px;
        font-weight: 600;
        border-radius: 6px 6px 0 0;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.2s;
      }
      .modal-category-header:hover {
        background: #e8e8e8;
      }
      .modal-category-header.active {
        background: #2196f3;
        color: white;
      }
      .modal-category-arrow {
        transition: transform 0.3s;
      }
      .modal-category-header.active .modal-category-arrow {
        transform: rotate(180deg);
      }
      .modal-category-products {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
        border: 1px solid #e0e0e0;
        border-top: none;
        border-radius: 0 0 6px 6px;
      }
      .modal-category-products.active {
        max-height: 400px;
        overflow-y: auto;
      }
      .modal-product-item {
        padding: 12px 16px;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.2s;
      }
      .modal-product-item:hover {
        background: #f9f9f9;
      }
      .modal-product-item:last-child {
        border-bottom: none;
      }
      .modal-product-name {
        font-size: 15px;
        font-weight: 500;
      }
      .modal-product-controls {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .modal-add-btn {
        padding: 8px 20px;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }
      .modal-add-btn:hover {
        background: #45a049;
      }
      .modal-add-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .modal-footer {
        padding: 20px 30px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }
      .added-products-section {
        background: #e8f5e9;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
        border-right: 4px solid #4caf50;
      }
      .added-products-section h3 {
        font-size: 16px;
        margin-bottom: 10px;
        color: #2e7d32;
      }
      .added-product-tag {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: white;
        padding: 6px 12px;
        border-radius: 20px;
        margin: 4px;
        font-size: 14px;
        border: 1px solid #4caf50;
      }
      .remove-added-product {
        background: none;
        border: none;
        color: #f44336;
        font-size: 18px;
        cursor: pointer;
        padding: 0;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.2s;
      }
      .remove-added-product:hover {
        background: #ffebee;
      }

      @media (max-width: 768px) {
        body {
          padding: 10px;
        }
        .header {
          padding: 30px 20px;
        }
        .brand {
          font-size: 36px;
        }
        .header-title {
          font-size: 20px;
        }
        .info-section {
          padding: 20px;
        }
        .info-grid {
          grid-template-columns: 1fr;
        }
        .content {
          padding: 20px;
        }
        .instruction {
          padding: 15px;
        }
        .products-table th,
        .products-table td {
          padding: 10px 8px;
          font-size: 13px;
        }
        .quantity-btn {
          width: 40px;
          height: 40px;
          font-size: 20px;
        }
        .quantity-display {
          min-width: 50px;
          font-size: 16px;
          padding: 6px 8px;
        }
        .actions {
          flex-direction: column;
          padding: 15px 20px;
        }
        .btn {
          width: 100%;
          padding: 14px 20px;
          font-size: 16px;
        }
        .modal-content {
          max-height: 95vh;
        }
        .modal-header {
          padding: 15px 20px;
        }
        .modal-body {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="spinner"></div>
      <div class="loading-text">××¢×‘×“ ××ª ×”××™×©×•×¨...</div>
      <div class="loading-subtext">×× × ×”××ª×Ÿ, ×–×” ×¢×©×•×™ ×œ×§×—×ª ××¡×¤×¨ ×©× ×™×•×ª</div>
    </div>

    <div class="container">
      <div class="header">
        <div class="brand">ZUZA</div>
        <div class="brand-subtitle">P Ã‚ T I S S E R I E</div>
        <div class="header-title">××™×©×•×¨ ×ª×¢×•×“×ª ××©×œ×•×—</div>
      </div>

      <div id="loadingState">
        <div class="loading">
          <div class="spinner"></div>
          <p style="color: #666; font-size: 16px">×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
        </div>
      </div>

      <div id="errorState" style="display: none"></div>

      <div id="mainContent" style="display: none">
        <div class="info-section">
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">×ª××¨×™×š ×•×©×¢×”</div>
              <div class="info-value" id="deliveryDateTime">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">××¡×¤×¨ ×ª×¢×•×“×”</div>
              <div class="info-value" id="certNumber">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">×××œ× ×”×ª×¢×•×“×”</div>
              <div class="info-value" id="fillerName">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">×¡×”"×› ××•×¦×¨×™×</div>
              <div class="info-value" id="totalProducts">-</div>
            </div>
          </div>
        </div>

        <div class="content">
          <div class="instruction">
            <h2>ğŸ” ×‘×“×•×§ ×•×”×ª×× ×›××•×™×•×ª</h2>
            <p>
              ×¢×‘×•×¨ ×¢×œ ×”××•×¦×¨×™× ×•×‘×“×•×§ ×©×”×›××•×™×•×ª ×ª×•×××•×ª ×œ××” ×©×”×ª×§×‘×œ ×‘×¤×•×¢×œ. ×”×©×ª××© ×‘×›×¤×ª×•×¨×™ + ×•- ×œ×©×™× ×•×™
              ×”×›××•×™×•×ª. ×× ×”×›×œ ×ª×•×× - ×œ×—×¥ ×¢×œ "××™×©×•×¨ ××œ×". ×× ×™×© ×”×‘×“×œ×™× - ×©× ×” ××ª ×”×›××•×™×•×ª ×•×œ×—×¥ "××™×©×•×¨
              ×¢× ×©×™× ×•×™×™×".
            </p>
          </div>

          <div id="productsContainer"></div>
        </div>

        <div class="actions">
          <button class="btn btn-confirm" id="btnFullConfirm">âœ“ ××™×©×•×¨ ××œ×</button>
          <button class="btn btn-custom" id="btnCustomConfirm">ğŸ” ××™×©×•×¨ ×¢× ×©×™× ×•×™×™×</button>
          <button
            class="btn btn-add-products"
            id="btnAddProducts"
            style="
              background: #2196f3;
              color: white;
              box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
            "
          >
            + ×”×•×¡×¤×ª ××•×¦×¨×™× ×©× ×©×›×—×•
          </button>
        </div>
      </div>

      <div id="successState" style="display: none">
        <div class="success">
          <h2>âœ“ ×”××™×©×•×¨ ×”×ª×§×‘×œ ×‘×”×¦×œ×—×”</h2>
          <p>×ª×¢×•×“×ª ×”××©×œ×•×— ×¢×•×“×›× ×” ×‘××¢×¨×›×ª.<br />×ª×•×“×” ×¢×œ ×”××™×©×•×¨!</p>
        </div>
      </div>
    </div>

    <!-- Add Products Modal -->
    <div class="modal-overlay" id="addProductsModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>×”×•×¡×¤×ª ××•×¦×¨×™× ×©× ×©×›×—×•</h2>
          <button class="modal-close" onclick="closeAddProductsModal()">Ã—</button>
        </div>
        <div class="modal-body">
          <div class="modal-search">
            <input
              type="text"
              id="modalSearchInput"
              placeholder="×—×™×¤×•×© ××•×¦×¨..."
              oninput="filterModalProducts(this.value)"
            />
          </div>
          <div id="modalCategoriesContainer"></div>
          <div class="added-products-section" id="addedProductsSection" style="display: none">
            <h3>××•×¦×¨×™× ×©× ×•×¡×¤×•:</h3>
            <div id="addedProductsList"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn"
            style="background: #666; color: white"
            onclick="closeAddProductsModal()"
          >
            ×¡×’×•×¨
          </button>
          <button class="btn btn-confirm" onclick="saveAddedProducts()">âœ“ ×©××•×¨ ×•×”×•×¡×£ ×œ××©×œ×•×—</button>
        </div>
      </div>
    </div>

    <script>
      const SCRIPT_URL =
        'https://script.google.com/macros/s/AKfycbwnjpxUWcVhDDfpfXwwtZnoVCjArg4djTiQIySwkB9IKYzQrTw6H0CHpN7IV08Lu7LFcA/exec';

      let deliveryData = null;
      let originalQuantities = {};
      let isSubmitting = false;
      let addedProducts = {}; // Tracks products added from modal: {productKey: {name, category, quantity}}

      // PRODUCT KEYS - WITH HANUKKAH 2025
      const PRODUCT_KEYS = {
        // Hanukkah 2025 Donuts
        '×§×©×™×• ×’×•×œ×“': 'hanukkah_cashew_gold',
        "×©×•×§×•×œ×“ ×§×¨×× ×¥'": 'hanukkah_chocolate_crunch',
        '×’×‘×™× ×” ×¤×™×¨×•×¨×™×': 'hanukkah_cheese_crumbs',
        ×¡×•×›×¨×™×•×ª: 'hanukkah_candies',
        '×•× ×™×œ ×¤×˜×œ': 'hanukkah_vanilla_raspberry',
        ×¤×™×¡×˜×•×§: 'hanukkah_pistachio',
        '×× ×’×• ×¤×¡×™×¤×œ×•×¨×”': 'hanukkah_mango_passionfruit',
        ×¤×˜×™×¡×™×™×¨: 'hanukkah_patissier',
        ×§×™× ××•×Ÿ: 'hanukkah_cinnamon',
        '×¡× ×˜ ×”×•× ×•×¨×”': 'hanukkah_saint_honore',
        // Sweet pastries
        '×§×¨×•××¡×•×Ÿ ×—×××”': 'sweet_croissant_butter',
        '×§×¨×•××¡×•×Ÿ ×©×•×§×•×œ×“': 'sweet_croissant_chocolate',
        '×××¤×” ×¤×™×¨×•×ª': 'sweet_fruit_pastry',
        '×××¤×” ×¤×§××Ÿ': 'sweet_pecan_pastry',
        '×××¤×” ×©×§×“×™× ×©×•×§×•×œ×“ ×—×œ×‘': 'sweet_almond_milk_chocolate',
        ×¡×™× ×‘×•×Ÿ: 'sweet_cinnamon',
        '×¤××Ÿ ×¡×•×•×™×¡': 'sweet_pain_suisse',
        '×××¤×” ×¤×¤×™×•×Ÿ': 'sweet_butterfly_pastry',
        '×××¤×” ×©×ª×™ ×•×¢×¨×‘': 'sweet_shti_veerev',
        ×¨×•×’×œ×š: 'sweet_rugelach',
        "×©×•×§×•×œ×“ ×¦'×™×¤×¡": 'sweet_chocolate_chips',
        '×§×¨×•××¡×•×Ÿ ×¤×™×¡×˜×•×§': 'sweet_croissant_pistachio',
        '×§×¨×•××¡×•×Ÿ ×’×‘×™× ×” ×¤×™×¨×•×ª ×™×¢×¨': 'sweet_croissant_cheese_berry',
        '×§×¨×•××¡×•×Ÿ ×©×§×“×™×': 'sweet_croissant_almonds',
        '×§×•×•×™×Ÿ ××××Ÿ': 'sweet_kouign_amann',
        // Salty
        '×œ×—×× ×™×” ×¨×™×§×”': 'salty_empty_bun',
        '×‘×™×™×’×œ ×¨×™×§': 'salty_empty_bagel',
        '×œ×—×× ×™×ª ×¤×¨×’ ×¨×™×§×”': 'salty_empty_poppy_bun',
        '×‘×•×¨×§×¡ ×’×‘×™× ×” ×¨×™×§': 'salty_empty_cheese_bourekas',
        '×××¤×” ××œ×•×— (××œ×‘×Ÿ)': 'salty_rectangle_pastry',
        "×¨×™×‘×•×¢×™ ×¤×•×§××¦'×”": 'salty_focaccia_squares',
        "×¤×•×§××¦'×” ××™×©×™×ª": 'salty_personal_focaccia',
        '×§×™×© ×§.10': 'salty_quiche_10',
        ×‘×™×™×’×œ×¡×•×Ÿ: 'salty_bagelson',
        '×—×œ×•×ª ×‘×¨×™×•×©': 'salty_brioche_challah',
        '×›×™×›×¨ ×œ×—×': 'salty_bread_loaf',
        // Sandwiches
        '××—××¦×ª ×¡×œ×§': 'sandwiches_beet_sourdough',
        '××—××¦×ª ×—×¦×™×œ×™×': 'sandwiches_eggplant_sourdough',
        '×‘×¨×™×•×© ×¤×¨×’ ×§×××‘×¨': 'sandwiches_brioche_poppy_camembert',
        '×›×¨×™×š ×‘×•×¨×§×¡ ×’×‘×™× ×•×ª': 'sandwiches_bourekas_cheeses',
        '×›×¨×™×š ×§×¨×•××¡×•×Ÿ ×—×××”': 'sandwiches_croissant_butter',
        '×›×¨×™×š ×‘×™×™×’×œ': 'sandwiches_bagel',
        '×××¤×” ×’×‘×™× ×•×ª ×¡×‘×™×—': 'sandwiches_focaccia',
        // Shelf products
        '×¢×•×’×ª ×©××¨×™×': 'shelf_yeast_cake',
        ×—×œ×•×ª: 'shelf_challah',
        ×‘×—×•×©×•×ª: 'shelf_thick',
        // Whole cakes
        "×¤×¡ ×¤××“×’' ××¡×§×¨×¤×•× ×”": 'whole_cakes_fudge_mascarpone_strip',
        '×¤×¡ ×¨×•×©×” ××’×•×–×™ ×œ×•×–': 'whole_cakes_rusha_hazelnut_strip',
        '×¤×¡ ×× ×’×• ×¤×¡×™×¤×œ×•×¨×”': 'whole_cakes_mango_passionfruit_strip',
        '×¤×¡ ×§×¤×” ×¤×§××Ÿ': 'whole_cakes_coffee_pecan_strip',
        '×˜×¨×™×§×•×œ×“ ×§.20': 'whole_cakes_tricolor_20',
        '×¤×™×¡×˜×•×§ ×¤×™×¨×•×ª ×™×¢×¨ ×§.20': 'whole_cakes_pistachio_berry_20',
        '×’×‘×™× ×” ×¤×™×¨×•×¨×™× ×§.20': 'whole_cakes_cheese_crumbs_20',
        '×’×‘×™× ×” ××¤×•×™×” ×§.20': 'whole_cakes_baked_cheese_20',
        '×¨×™×‘×•×¢ ×¨×•×©×” ××’×•×–×™ ×œ×•×–': 'whole_cakes_rusha_hazelnut_square',
        '×¨×™×‘×•×¢ ×§×¤×” ×¤×§××Ÿ': 'whole_cakes_coffee_pecan_square',
        "×¤××“×’' ×©×•×§×•×œ×“": 'whole_cakes_chocolate_fudge',
        // Vitrina desserts
        "×§×©×™×• ×“×•×œ×¦'×”": 'vitrina_cashew_dolce',
        '×¤×™×¡×˜×•×§ ×¤×™×¨×•×ª ×™×¢×¨': 'vitrina_pistachio_berry',
        '×¤×—×–× ×™×ª ×•× ×™×œ ×¤×˜×œ': 'vitrina_pheasant_vanilla_raspberry',
        '×¡×‘×œ×” ×¤×§××Ÿ': 'vitrina_sabla_pecan',
        '×˜××¨×˜ ×¤×™×¨×•×ª': 'vitrina_fruit_tart',
        '×˜××¨×˜ ×œ×™××•×Ÿ 100%': 'vitrina_lemon_tart_100',
        '100 ××—×•×– ×©×•×§×•×œ×“': 'vitrina_chocolate_100',
        '×¨×•×©×” ××’×•×–×™ ×œ×•×–': 'vitrina_rusha_hazelnut',
        '×¤×¨×™×– ×‘×¨×¡×˜': 'vitrina_paris_brest',
        '×›×“×•×¨ ×©×•×§×•×œ×“': 'vitrina_chocolate_ball',
        '×¤×—×–× ×™×ª ×•× ×™×œ ××™×©×™×ª': 'vitrina_personal_pheasant_vanilla',
        // Cookies
        ×¤×œ×•×¨× ×˜×™×Ÿ: 'cookies_florentine',
        '×§×¤×” ×©×§×“×™×': 'cookies_coffee_almonds',
        '×©×§×“×™× ×œ×™××•×Ÿ': 'cookies_almonds_lemon',
        ×¤×§××Ÿ: 'cookies_pecan',
        ×‘×¨××•× ×™×–: 'cookies_brownies',
        '×—×××” ×œ×•×–': 'cookies_butter_hazelnut',
        ×¤×¨××–×Ÿ: 'cookies_parmesan',
        '×¢×•×’×™×•×ª ×ª××¨×™×': 'cookies_dates',
        ××œ×¤×—×•×¨×¡: 'cookies_alfajores',
        '×¤×™×¡×˜×•×§ ×œ×œ"×’': 'cookies_pistachio_lag_baomer',
        '×§×§××• ×©×•×§×•×œ×“': 'cookies_cocoa_chocolate',
        // Various
        '×××¤×” ×¤×˜×¨×™×•×ª': 'various_mushroom_pastry',
        '×××¤×” ×’×‘×™× ×” ×•×¤×™×¨×•×ª ×™×¢×¨': 'various_cheese_berry_pastry',
        '×¢×•×’×ª ×’×‘×™× ×” ×‘××¡×§×™×ª': 'various_basque_cheesecake',
        '×—×œ××•×Ÿ ××¤×•×¡×˜×¨': 'various_yolk_pasteurized',
        '×¤×¨××–×Ÿ ×—×•××¨ ×’×œ×': 'various_parmesan_raw',
        '×©×× ×ª ××ª×•×§×”': 'various_sweet_cream',
        ×—×××”: 'various_butter',
        '×¤×¡ ×¤×™×¡×˜×•×§ ×¤×™×¨×•×ª ×™×¢×¨': 'various_pistachio_berry_strip',
        '×¤×¨×¡×‘×•×¨×’×¨ ×¤×¨×’': 'various_pressburger_poppy',
      };

      // Categories Data
      const CATEGORIES = {
        hanukkah2025: {
          name: '×¡×•×¤×’× ×™×•×ª ×—× ×•×›×” 2025',
          products: [
            '×§×©×™×• ×’×•×œ×“',
            "×©×•×§×•×œ×“ ×§×¨×× ×¥'",
            '×’×‘×™× ×” ×¤×™×¨×•×¨×™×',
            '×¡×•×›×¨×™×•×ª',
            '×•× ×™×œ ×¤×˜×œ',
            '×¤×™×¡×˜×•×§',
            '×× ×’×• ×¤×¡×™×¤×œ×•×¨×”',
            '×¤×˜×™×¡×™×™×¨',
            '×§×™× ××•×Ÿ',
            '×¡× ×˜ ×”×•× ×•×¨×”',
          ],
        },
        sweet: {
          name: '×××¤×™× ××ª×•×§×™×',
          products: [
            '×§×¨×•××¡×•×Ÿ ×—×××”',
            '×§×¨×•××¡×•×Ÿ ×©×•×§×•×œ×“',
            '×××¤×” ×¤×™×¨×•×ª',
            '×××¤×” ×¤×§××Ÿ',
            '×××¤×” ×©×§×“×™× ×©×•×§×•×œ×“ ×—×œ×‘',
            '×¡×™× ×‘×•×Ÿ',
            '×¤××Ÿ ×¡×•×•×™×¡',
            '×××¤×” ×¤×¤×™×•×Ÿ',
            '×××¤×” ×©×ª×™ ×•×¢×¨×‘',
            '×¨×•×’×œ×š',
            "×©×•×§×•×œ×“ ×¦'×™×¤×¡",
            '×§×¨×•××¡×•×Ÿ ×¤×™×¡×˜×•×§',
            '×§×¨×•××¡×•×Ÿ ×’×‘×™× ×” ×¤×™×¨×•×ª ×™×¢×¨',
            '×§×¨×•××¡×•×Ÿ ×©×§×“×™×',
            '×§×•×•×™×Ÿ ××××Ÿ',
          ],
        },
        salty: {
          name: '××œ×•×—×™×',
          products: [
            '×œ×—×× ×™×” ×¨×™×§×”',
            '×‘×™×™×’×œ ×¨×™×§',
            '×œ×—×× ×™×ª ×¤×¨×’ ×¨×™×§×”',
            '×‘×•×¨×§×¡ ×’×‘×™× ×” ×¨×™×§',
            '×××¤×” ××œ×•×— (××œ×‘×Ÿ)',
            "×¨×™×‘×•×¢×™ ×¤×•×§××¦'×”",
            "×¤×•×§××¦'×” ××™×©×™×ª",
            '×§×™×© ×§.10',
            '×‘×™×™×’×œ×¡×•×Ÿ',
            '×—×œ×•×ª ×‘×¨×™×•×©',
            '×›×™×›×¨ ×œ×—×',
          ],
        },
        sandwiches: {
          name: '×›×¨×™×›×™×',
          products: [
            '××—××¦×ª ×¡×œ×§',
            '××—××¦×ª ×—×¦×™×œ×™×',
            '×‘×¨×™×•×© ×¤×¨×’ ×§×××‘×¨',
            '×›×¨×™×š ×‘×•×¨×§×¡ ×’×‘×™× ×•×ª',
            '×›×¨×™×š ×§×¨×•××¡×•×Ÿ ×—×××”',
            '×›×¨×™×š ×‘×™×™×’×œ',
            '×××¤×” ×’×‘×™× ×•×ª ×¡×‘×™×—',
          ],
        },
        shelf: {
          name: '××•×¦×¨×™ ××“×£',
          products: ['×¢×•×’×ª ×©××¨×™×', '×—×œ×•×ª', '×‘×—×•×©×•×ª'],
        },
        whole_cakes: {
          name: '×¢×•×’×•×ª ×©×œ××•×ª',
          products: [
            "×¤×¡ ×¤××“×’' ××¡×§×¨×¤×•× ×”",
            '×¤×¡ ×¨×•×©×” ××’×•×–×™ ×œ×•×–',
            '×¤×¡ ×× ×’×• ×¤×¡×™×¤×œ×•×¨×”',
            '×¤×¡ ×§×¤×” ×¤×§××Ÿ',
            '×˜×¨×™×§×•×œ×“ ×§.20',
            '×¤×™×¡×˜×•×§ ×¤×™×¨×•×ª ×™×¢×¨ ×§.20',
            '×’×‘×™× ×” ×¤×™×¨×•×¨×™× ×§.20',
            '×’×‘×™× ×” ××¤×•×™×” ×§.20',
            '×¨×™×‘×•×¢ ×¨×•×©×” ××’×•×–×™ ×œ×•×–',
            '×¨×™×‘×•×¢ ×§×¤×” ×¤×§××Ÿ',
            "×¤××“×’' ×©×•×§×•×œ×“",
          ],
        },
        vitrina: {
          name: '×§×™× ×•×—×™ ×•×™×˜×¨×™× ×”',
          products: [
            "×§×©×™×• ×“×•×œ×¦'×”",
            '×¤×™×¡×˜×•×§ ×¤×™×¨×•×ª ×™×¢×¨',
            '×¤×—×–× ×™×ª ×•× ×™×œ ×¤×˜×œ',
            '×¡×‘×œ×” ×¤×§××Ÿ',
            '×˜××¨×˜ ×¤×™×¨×•×ª',
            '×˜××¨×˜ ×œ×™××•×Ÿ 100%',
            '100 ××—×•×– ×©×•×§×•×œ×“',
            '×¨×•×©×” ××’×•×–×™ ×œ×•×–',
            '×¤×¨×™×– ×‘×¨×¡×˜',
            '×›×“×•×¨ ×©×•×§×•×œ×“',
            '×¤×—×–× ×™×ª ×•× ×™×œ ××™×©×™×ª',
          ],
        },
        cookies: {
          name: '×¢×•×’×™×•×ª',
          products: [
            '×¤×œ×•×¨× ×˜×™×Ÿ',
            '×§×¤×” ×©×§×“×™×',
            '×©×§×“×™× ×œ×™××•×Ÿ',
            '×¤×§××Ÿ',
            '×‘×¨××•× ×™×–',
            '×—×××” ×œ×•×–',
            '×¤×¨××–×Ÿ',
            '×¢×•×’×™×•×ª ×ª××¨×™×',
            '××œ×¤×—×•×¨×¡',
            '×¤×™×¡×˜×•×§ ×œ×œ"×’',
            '×§×§××• ×©×•×§×•×œ×“',
          ],
        },
        various: {
          name: '××•×¦×¨×™× ×©×•× ×™×',
          products: [
            '×××¤×” ×¤×˜×¨×™×•×ª',
            '×××¤×” ×’×‘×™× ×” ×•×¤×™×¨×•×ª ×™×¢×¨',
            '×¢×•×’×ª ×’×‘×™× ×” ×‘××¡×§×™×ª',
            '×—×œ××•×Ÿ ××¤×•×¡×˜×¨',
            '×¤×¨××–×Ÿ ×—×•××¨ ×’×œ×',
            '×©×× ×ª ××ª×•×§×”',
            '×—×××”',
            '×¤×¡ ×¤×™×¡×˜×•×§ ×¤×™×¨×•×ª ×™×¢×¨',
            '×¤×¨×¡×‘×•×¨×’×¨ ×¤×¨×’',
          ],
        },
      };

      function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        return {
          day: params.get('day'),
          submission_id: params.get('submission_id'),
        };
      }

      function formatDateTime(submissionTime) {
        console.log('Formatting time:', submissionTime);

        if (submissionTime && typeof submissionTime === 'string') {
          if (submissionTime.match(/^\d{2}\/\d{2}\/\d{4} \d{2}:\d{2}$/)) {
            return submissionTime;
          }
        }

        console.error('Invalid submission time format:', submissionTime);
        return '×–××Ÿ ×œ× ×–××™×Ÿ';
      }

      async function loadDeliveryData() {
        try {
          const params = getUrlParams();

          if (!params.day || !params.submission_id) {
            throw new Error('×—×¡×¨×™× ×¤×¨××˜×¨×™× ×‘×§×™×©×•×¨');
          }

          const url = `${SCRIPT_URL}?action=get_delivery&day=${
            params.day
          }&submission_id=${encodeURIComponent(params.submission_id)}`;
          console.log('Loading from:', url);

          const response = await fetch(url, {
            method: 'GET',
            redirect: 'follow',
          });

          if (!response.ok) {
            throw new Error(`×©×’×™××ª ×©×¨×ª: ${response.status}`);
          }

          const result = await response.json();
          console.log('Response:', result);

          if (!result.success) {
            throw new Error(result.error || '×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×');
          }

          deliveryData = result.data;
          console.log('Delivery data:', deliveryData);
          console.log('Submission time:', deliveryData.submission_time);

          deliveryData.products.forEach((product) => {
            originalQuantities[product.key] = product.quantity;
          });

          displayDeliveryData();
        } catch (error) {
          console.error('Error:', error);
          showError(`×©×’×™××”: ${error.message}`);
        }
      }

      function displayDeliveryData() {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';

        const dateTime = formatDateTime(deliveryData.submission_time);
        console.log('Formatted date/time:', dateTime);

        document.getElementById('deliveryDateTime').textContent = dateTime;
        document.getElementById('certNumber').textContent = deliveryData.certificate_number;
        document.getElementById('fillerName').textContent = deliveryData.filler_name;
        document.getElementById('totalProducts').textContent = deliveryData.products.length;

        const categorized = {};
        deliveryData.products.forEach((product) => {
          if (!categorized[product.category]) {
            categorized[product.category] = [];
          }
          categorized[product.category].push(product);
        });

        const container = document.getElementById('productsContainer');
        container.innerHTML = '';

        Object.keys(categorized).forEach((category) => {
          const section = document.createElement('div');
          section.className = 'category-section';

          const header = document.createElement('div');
          header.className = 'category-header';
          header.textContent = category;
          section.appendChild(header);

          const table = document.createElement('table');
          table.className = 'products-table';

          const thead = document.createElement('thead');
          thead.innerHTML = `
                    <tr>
                        <th>×©× ××•×¦×¨</th>
                        <th class="quantity-col">×›××•×ª</th>
                        <th>×”×¢×¨×•×ª</th>
                    </tr>
                `;
          table.appendChild(thead);

          const tbody = document.createElement('tbody');
          categorized[category].forEach((product) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                        <td><div class="product-name">${product.name}</div></td>
                        <td>
                            <div class="quantity-input-wrapper">
                                <button 
                                    class="quantity-btn minus" 
                                    data-product-key="${product.key}"
                                    onclick="changeQuantity('${product.key}', -1)"
                                    ${product.quantity === 0 ? 'disabled' : ''}
                                >âˆ’</button>
                                <div 
                                    class="quantity-display" 
                                    id="qty-${product.key}"
                                    data-original="${product.quantity}"
                                    data-product-key="${product.key}"
                                    data-product-name="${product.name}"
                                >${product.quantity}</div>
                                <button 
                                    class="quantity-btn plus" 
                                    data-product-key="${product.key}"
                                    onclick="changeQuantity('${product.key}', 1)"
                                >+</button>
                            </div>
                        </td>
                        <td><div class="product-notes">${product.notes || '-'}</div></td>
                    `;
            tbody.appendChild(tr);
          });
          table.appendChild(tbody);
          section.appendChild(table);
          container.appendChild(section);
        });

        document.getElementById('btnFullConfirm').addEventListener('click', handleFullConfirm);
        document.getElementById('btnCustomConfirm').addEventListener('click', handleCustomConfirm);
        document.getElementById('btnAddProducts').addEventListener('click', openAddProductsModal);
      }

      function changeQuantity(productKey, delta) {
        const display = document.getElementById(`qty-${productKey}`);
        const currentQty = parseInt(display.textContent);
        const newQty = Math.max(0, currentQty + delta);

        display.textContent = newQty;

        const original = parseInt(display.dataset.original);
        if (newQty !== original) {
          display.classList.add('changed');
        } else {
          display.classList.remove('changed');
        }

        const minusBtn = document.querySelector(
          `.quantity-btn.minus[data-product-key="${productKey}"]`
        );
        if (minusBtn) {
          minusBtn.disabled = newQty === 0;
        }
      }

      async function handleFullConfirm() {
        if (isSubmitting) return;

        if (!confirm('×”×× ×›×œ ×”××•×¦×¨×™× ×”×’×™×¢×• ×‘××œ×•××?')) {
          return;
        }
        await submitConfirmation(true);
      }

      async function handleCustomConfirm() {
        if (isSubmitting) return;

        const changedDisplays = document.querySelectorAll('.quantity-display.changed');

        if (changedDisplays.length === 0) {
          alert('×œ× ×–×•×”×• ×©×™× ×•×™×™×. ×œ×—×¥ ×¢×œ "××™×©×•×¨ ××œ×" ×× ×”×›×œ ×‘×¡×“×¨.');
          return;
        }

        if (!confirm(`×–×•×”×• ${changedDisplays.length} ×©×™× ×•×™×™×. ×œ××©×¨?`)) {
          return;
        }

        await submitConfirmation(false);
      }

      async function submitConfirmation(fullConfirmation) {
        if (isSubmitting) {
          console.log('Already submitting, ignoring duplicate request');
          return;
        }

        isSubmitting = true;

        try {
          const btnFull = document.getElementById('btnFullConfirm');
          const btnCustom = document.getElementById('btnCustomConfirm');
          btnFull.disabled = true;
          btnCustom.disabled = true;

          document.getElementById('loadingOverlay').classList.add('show');

          const params = getUrlParams();

          const confirmedProducts = [];
          document.querySelectorAll('.quantity-display').forEach((display) => {
            confirmedProducts.push({
              key: display.dataset.productKey,
              name: display.dataset.productName,
              quantity: parseInt(display.textContent) || 0,
            });
          });

          const confirmationData = {
            action: 'confirm',
            day: params.day,
            submission_id: params.submission_id,
            full_confirmation: fullConfirmation,
            confirmed_products: confirmedProducts,
          };

          console.log('Submitting confirmation:', confirmationData);

          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 60000);

          const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(confirmationData),
            redirect: 'follow',
            signal: controller.signal,
          });

          clearTimeout(timeoutId);
          console.log('Request completed');

          document.getElementById('loadingOverlay').classList.remove('show');

          document.getElementById('mainContent').style.display = 'none';
          document.getElementById('successState').style.display = 'block';
        } catch (error) {
          console.error('Error:', error);
          document.getElementById('loadingOverlay').classList.remove('show');

          if (error.name === 'AbortError') {
            alert('×”×‘×§×©×” ××¨×›×” ×™×•×ª×¨ ××“×™. ×™×™×ª×›×Ÿ ×©×”××™×©×•×¨ ×¢×‘×¨ ×‘×”×¦×œ×—×” - × × ×œ×‘×“×•×§ ×¢× ×”×× ×”×œ.');
          } else {
            alert(`×©×’×™××”: ${error.message}\n\n× ×¡×” ×©× ×™×ª ××• ×¤× ×” ×œ×ª××™×›×”.`);
          }

          document.getElementById('btnFullConfirm').disabled = false;
          document.getElementById('btnCustomConfirm').disabled = false;
        } finally {
          isSubmitting = false;
        }
      }

      function showError(message) {
        document.getElementById('loadingState').style.display = 'none';
        const errorDiv = document.getElementById('errorState');
        errorDiv.innerHTML = `<div class="error"><strong>×©×’×™××”:</strong> ${message}</div>`;
        errorDiv.style.display = 'block';
      }

      // ============================================================================
      // ADD PRODUCTS MODAL FUNCTIONS
      // ============================================================================

      function openAddProductsModal() {
        document.getElementById('addProductsModal').classList.add('show');
        renderModalCategories();
        document.body.style.overflow = 'hidden';
      }

      function closeAddProductsModal() {
        document.getElementById('addProductsModal').classList.remove('show');
        document.getElementById('modalSearchInput').value = '';
        document.body.style.overflow = '';
      }

      function renderModalCategories() {
        const container = document.getElementById('modalCategoriesContainer');
        container.innerHTML = '';

        Object.entries(CATEGORIES).forEach(([categoryKey, categoryData]) => {
          const categoryDiv = document.createElement('div');
          categoryDiv.className = 'modal-category';

          const header = document.createElement('div');
          header.className = 'modal-category-header';
          header.innerHTML = `
            <span>${categoryData.name}</span>
            <span class="modal-category-arrow">â–¼</span>
          `;
          header.onclick = () => toggleModalCategory(categoryKey);
          categoryDiv.appendChild(header);

          const productsDiv = document.createElement('div');
          productsDiv.className = 'modal-category-products';
          productsDiv.id = `modal-cat-${categoryKey}`;

          categoryData.products.forEach((productName) => {
            const productKey = PRODUCT_KEYS[productName];
            if (!productKey) return;

            // Check if already in delivery or added
            const alreadyInDelivery = deliveryData.products.some((p) => p.key === productKey);
            const alreadyAdded = addedProducts[productKey];

            const productItem = document.createElement('div');
            productItem.className = 'modal-product-item';
            productItem.dataset.productName = productName.toLowerCase();

            productItem.innerHTML = `
              <div class="modal-product-name">${productName}</div>
              <div class="modal-product-controls">
                ${
                  alreadyInDelivery
                    ? '<span style="color: #666; font-size: 13px;">×›×‘×¨ ×‘××©×œ×•×—</span>'
                    : alreadyAdded
                    ? '<span style="color: #4caf50; font-size: 13px;">× ×•×¡×£ âœ“</span>'
                    : `<button class="modal-add-btn" onclick="addProductToList('${productKey}', '${productName.replace(
                        /'/g,
                        "\\'"
                      )}', '${categoryData.name}')">×”×•×¡×£ +</button>`
                }
              </div>
            `;

            productsDiv.appendChild(productItem);
          });

          categoryDiv.appendChild(productsDiv);
          container.appendChild(categoryDiv);
        });
      }

      function toggleModalCategory(categoryKey) {
        const header = document.querySelector(`#modal-cat-${categoryKey}`).previousElementSibling;
        const productsDiv = document.getElementById(`modal-cat-${categoryKey}`);

        header.classList.toggle('active');
        productsDiv.classList.toggle('active');
      }

      function filterModalProducts(searchTerm) {
        const lowerSearch = searchTerm.toLowerCase();
        const productItems = document.querySelectorAll('.modal-product-item');

        productItems.forEach((item) => {
          const productName = item.dataset.productName;
          if (productName.includes(lowerSearch)) {
            item.style.display = 'flex';
          } else {
            item.style.display = 'none';
          }
        });
      }

      function addProductToList(productKey, productName, categoryName) {
        // Add to addedProducts tracker
        addedProducts[productKey] = {
          name: productName,
          category: categoryName,
          quantity: 1,
        };

        // Update UI
        renderAddedProductsList();
        renderModalCategories(); // Refresh to show "× ×•×¡×£" status
      }

      function renderAddedProductsList() {
        const section = document.getElementById('addedProductsSection');
        const list = document.getElementById('addedProductsList');

        if (Object.keys(addedProducts).length === 0) {
          section.style.display = 'none';
          return;
        }

        section.style.display = 'block';
        list.innerHTML = '';

        Object.entries(addedProducts).forEach(([productKey, product]) => {
          const tag = document.createElement('div');
          tag.className = 'added-product-tag';
          tag.innerHTML = `
            <span>${product.name} (${product.quantity})</span>
            <button class="remove-added-product" onclick="removeAddedProduct('${productKey}')">Ã—</button>
          `;
          list.appendChild(tag);
        });
      }

      function removeAddedProduct(productKey) {
        delete addedProducts[productKey];
        renderAddedProductsList();
        renderModalCategories(); // Refresh to remove "× ×•×¡×£" status
      }

      function saveAddedProducts() {
        if (Object.keys(addedProducts).length === 0) {
          alert('×œ× × ×‘×—×¨×• ××•×¦×¨×™× ×œ×”×•×¡×¤×”');
          return;
        }

        // Add products to the main display
        Object.entries(addedProducts).forEach(([productKey, product]) => {
          // Find or create the category section
          let categorySection = Array.from(document.querySelectorAll('.category-header'))
            .find((header) => header.textContent === product.category)
            ?.closest('.category-section');

          if (!categorySection) {
            // Create new category section
            categorySection = document.createElement('div');
            categorySection.className = 'category-section';

            const header = document.createElement('div');
            header.className = 'category-header';
            header.textContent = product.category;
            categorySection.appendChild(header);

            const table = document.createElement('table');
            table.className = 'products-table';
            table.innerHTML = `
              <thead>
                <tr>
                  <th>×©× ××•×¦×¨</th>
                  <th class="quantity-col">×›××•×ª</th>
                  <th>×”×¢×¨×•×ª</th>
                </tr>
              </thead>
              <tbody></tbody>
            `;
            categorySection.appendChild(table);
            document.getElementById('productsContainer').appendChild(categorySection);
          }

          // Add product row to table
          const tbody = categorySection.querySelector('tbody');
          const tr = document.createElement('tr');
          tr.style.background = '#e3f2fd'; // Highlight added products
          tr.innerHTML = `
            <td><div class="product-name">${product.name} <span style="color: #2196F3; font-size: 12px; font-weight: bold;">(× ×•×¡×£)</span></div></td>
            <td>
              <div class="quantity-input-wrapper">
                <button
                  class="quantity-btn minus"
                  data-product-key="${productKey}"
                  onclick="changeQuantity('${productKey}', -1)"
                  disabled
                >âˆ’</button>
                <div
                  class="quantity-display changed"
                  id="qty-${productKey}"
                  data-original="0"
                  data-product-key="${productKey}"
                  data-product-name="${product.name}"
                >${product.quantity}</div>
                <button
                  class="quantity-btn plus"
                  data-product-key="${productKey}"
                  onclick="changeQuantity('${productKey}', 1)"
                >+</button>
              </div>
            </td>
            <td><div class="product-notes">××•×¦×¨ ×©× ×•×¡×£ ×××•×—×¨ ×™×•×ª×¨</div></td>
          `;
          tbody.appendChild(tr);

          // Add to deliveryData for submission
          deliveryData.products.push({
            key: productKey,
            name: product.name,
            category: product.category,
            quantity: product.quantity,
            notes: '××•×¦×¨ ×©× ×•×¡×£ ×××•×—×¨ ×™×•×ª×¨',
          });
        });

        // Update total products count
        document.getElementById('totalProducts').textContent = deliveryData.products.length;

        // Save count before clearing
        const addedCount = Object.keys(addedProducts).length;

        // Clear added products and close modal
        addedProducts = {};
        closeAddProductsModal();

        alert(`× ×•×¡×¤×• ${addedCount} ××•×¦×¨×™× ×œ××©×œ×•×— ×‘×”×¦×œ×—×”!`);
      }

      window.addEventListener('DOMContentLoaded', loadDeliveryData);

      window.addEventListener('beforeunload', (e) => {
        if (isSubmitting) {
          e.preventDefault();
          e.returnValue = '';
        }
      });
    </script>
  </body>
</html>
